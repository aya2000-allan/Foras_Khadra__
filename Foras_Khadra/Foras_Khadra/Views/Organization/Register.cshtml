@model Foras_Khadra.ViewModels.RegisterOrganizationViewModel
@{
    ViewData["Title"] = "تسجيل حساب المنظمة";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<style>
    #v-pills-tab button {
        pointer-events: none;
        cursor: default;
    }

        #v-pills-tab button.active {
            pointer-events: auto;
        }

    input.pe-5 {
        padding-right: 2.5rem !important;
    }
</style>

<div class="container mt-5">
    <h2 class="mb-4 text-center">@ViewData["Title"]</h2>

    <div class="row">
        <!-- التابات الجانبية -->
        <div class="col-md-3 mb-3">
            <div class="nav flex-column nav-pills" id="v-pills-tab">
                <button class="nav-link" id="tab1-tab">معلومات المنظمة</button>
                <button class="nav-link" id="tab2-tab">الدولة والموقع</button>
                <button class="nav-link" id="tab3-tab">المعلومات الشخصية</button>
            </div>
        </div>

        <div class="col-md-9">
            <form asp-action="Register" method="post" id="registerForm">
                @Html.AntiForgeryToken()

                <div class="tab-content">

                    <!-- Tab 1 -->
                    <div class="tab-pane fade" id="tab1">
                        <div class="mb-3">
                            <label asp-for="Name">اسم المنظمة</label>                            <input asp-for="Name" id="Name" class="form-control" />
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Sector">اسم القطاع</label>                            <input asp-for="Sector" id="Sector" class="form-control" />
                            <span asp-validation-for="Sector" class="text-danger"></span>
                        </div>

                        <div class="d-flex justify-content-center gap-3">
                            <button type="button" class="btn btn-primary w-50" onclick="nextTab(1)">التالي</button>
                        </div>
                    </div>

                    <!-- Tab 2 -->
                    <div class="tab-pane fade" id="tab2">
                        <div class="row mb-3">
                            <div class="col">
                                <label asp-for="Country">الدولة</label>                                <select asp-for="Country" asp-items="Model.Countries" id="Country" class="form-select">
                                    <option value="">اختر الدولة</option>
                                </select>
                                <span asp-validation-for="Country" class="text-danger"></span>
                            </div>
                            <div class="col">
                                <label asp-for="Location">الموقع</label>                                <input asp-for="Location" id="Location" class="form-control" />
                                <span asp-validation-for="Location" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="d-flex justify-content-center gap-3">
                            <button type="button" class="btn btn-secondary w-50" onclick="prevTab(2)">رجوع</button>
                            <button type="button" class="btn btn-primary w-50" onclick="nextTab(2)">التالي</button>
                        </div>
                    </div>

                    <!-- Tab 3 -->
                    <div class="tab-pane fade" id="tab3">
                        <div class="row mb-3">
                            <div class="col">
                                <label asp-for="ContactName">جهة الاتصال</label>                                <input asp-for="ContactName" id="ContactName" class="form-control" />
                                <span asp-validation-for="ContactName" class="text-danger"></span>
                            </div>
                            <div class="col">
                                <label asp-for="ContactEmail">البريد الالكتروني</label>                                <input asp-for="ContactEmail" id="ContactEmail" class="form-control" />
                                <span asp-validation-for="ContactEmail" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col">
                                <label asp-for="Website">الموقع الالكتروني (اختياري)</label>                                <input asp-for="Website" id="Website" class="form-control" placeholder="https://example.com" />
                                <span asp-validation-for="Website" class="text-danger"></span>
                            </div>
                            <div class="col">
                                <label asp-for="PhoneNumber">رقم الهاتف</label>                            
                                <input asp-for="PhoneNumber" id="PhoneNumber" class="form-control" />
                                <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col position-relative">
                                <label asp-for="Password">كلمة المرور</label>                               
                                <input asp-for="Password" id="Password" type="password" class="form-control pe-5" />
                                <span class="position-absolute top-50 end-0 me-3" onclick="togglePassword('Password', this)">
                                    <i class="fa fa-eye"></i>
                                </span>
                                <span asp-validation-for="Password" class="text-danger"></span>
                            </div>
                            <div class="col position-relative">
                                <label asp-for="ConfirmPassword">تأكيد كلمة المرور</label>                               
                                <input asp-for="ConfirmPassword" id="ConfirmPassword" type="password" class="form-control pe-5" />
                                <span class="position-absolute top-50 end-0 me-3" onclick="togglePassword('ConfirmPassword', this)">
                                    <i class="fa fa-eye"></i>
                                </span>
                                <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="d-flex justify-content-center gap-3">
                            <button type="button" class="btn btn-secondary w-50" onclick="prevTab(3)">رجوع</button>
                            <button type="submit" class="btn btn-success w-50">إنشاء الحساب</button>
                        </div>
                    </div>
                </div>

                <div class="progress mt-3">
                    <div id="progressBar" class="progress-bar" style="width:33%">33%</div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        function togglePassword(id, el) {
            let input = document.getElementById(id);
            let icon = el.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        function switchTab(tab) {
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`tab${i}`).classList.remove('show','active');
                document.getElementById(`tab${i}-tab`).classList.remove('active');
            }
            document.getElementById(`tab${tab}`).classList.add('show','active');
            document.getElementById(`tab${tab}-tab`).classList.add('active');
            updateProgress(tab);
        }

        function nextTab(c) {
            if (!validateTab(c)) return;
            switchTab(c + 1);
        }

        function prevTab(c) {
            switchTab(c - 1);
        }

        function updateProgress(t) {
            let p = Math.round((t / 3) * 100);
            document.getElementById('progressBar').style.width = p + '%';
            document.getElementById('progressBar').innerText = p + '%';
        }

        function validateTab(t) {
            if (t === 1 && (!document.getElementById('Name').value.trim() || !document.getElementById('Sector').value.trim())) {
                alert('أكملي بيانات المنظمة');
                return false;
            }

            if (t === 2) {
                const country = document.getElementById('Country');
                const location = document.getElementById('Location');
                if (!country || !country.value.trim() || !location || !location.value.trim()) {
                    alert('أكملي بيانات الموقع');
                    return false;
                }
            }

            if (t === 3) {
                const contact = document.getElementById('ContactName');
                const email = document.getElementById('ContactEmail');
                const phone = document.getElementById('PhoneNumber');
                const password = document.getElementById('Password');
                const confirm = document.getElementById('ConfirmPassword');

                if (!contact.value.trim() || !email.value.trim() || !phone.value.trim()) {
                    alert('يرجى ملء جميع الحقول الإلزامية في المعلومات الشخصية.');
                    return false;
                }

                if(password.value !== confirm.value){
                    alert('كلمة المرور غير متطابقة');
                    return false;
                }
            }

            return true;
        }

        document.addEventListener("DOMContentLoaded", () => {
            let tab = 1;

            if (
                document.querySelector('[data-valmsg-for="ContactName"]')?.innerText.trim() ||
                document.querySelector('[data-valmsg-for="ContactEmail"]')?.innerText.trim() ||
                document.querySelector('[data-valmsg-for="Password"]')?.innerText.trim() ||
                document.querySelector('[data-valmsg-for="ConfirmPassword"]')?.innerText.trim() ||
                document.querySelector('[data-valmsg-for="PhoneNumber"]')?.innerText.trim()
            ) {
                tab = 3;
            } else if (
                document.querySelector('[data-valmsg-for="Country"]')?.innerText.trim() ||
                document.querySelector('[data-valmsg-for="Location"]')?.innerText.trim()
            ) {
                tab = 2;
            }

            switchTab(tab);
        });
    </script>
}