@model Foras_Khadra.Models.Contact

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "اتصل بنا";
}

<link rel="stylesheet" href="~/css/site.css" />

<div class="contact-header">اتصل بنا</div>
<div class="contact-desc">
    نقدر اهتمامكم وتواصلكم مع فريق فرص خضراء، ونسعى جاهدين لقراءة كافة الرسائل التي نتلقاها للرد عليها في أقرب وقت ممكن.
</div>

<div class="contact-container">
    <div class="contact-form-box">

        <form id="contactForm" class="contact-form" novalidate>

            <div class="row mb-4">
                <div class="col-md-6 mb-3 mb-md-0">
                    <input asp-for="FirstName" class="form-control" placeholder="أدخل اسمك الأول" required />
                    <span asp-validation-for="FirstName" class="text-danger small" ></span>
                </div>
                <div class="col-md-6">
                    <input asp-for="LastName" class="form-control" placeholder="أدخل اسمك الأخير" required />
                    <span asp-validation-for="LastName" class="text-danger small" ></span>
                </div>
            </div>

            <div class="mb-4">
                <input asp-for="Email" type="email" class="form-control" placeholder="أدخل بريدك الإلكتروني" required />
                <span asp-validation-for="Email" class="text-danger small" ></span>
            </div>

            <!-- Phone input (visible) -->
            <div class="mb-4">
                <input type="tel"
                       id="phoneInput"
                       class="form-control"
                       style="text-align:right;"
                       placeholder="أدخل رقم الهاتف"
                       required />
            </div>

            <!-- Real phone value -->
            <input type="hidden" asp-for="Phone" id="Phone" />

            <div class="mb-4">
                <textarea asp-for="MessageContent"
                          rows="5"
                          class="form-control"
                          placeholder="أدخل نص الرسالة ..." required></textarea>
                <span asp-validation-for="MessageContent" class="text-danger small"></span>
            </div>

            <input asp-for="Honeypot"
                   type="text"
                   style="display:none !important"
                   autocomplete="off"
                   tabindex="-1" />

            <div class="mb-4 d-flex justify-content-center">
                <div class="g-recaptcha" data-sitekey="6LfyK2wrAAAAABkGk-KUioJI_FtA1Kv31qTJ6Le9"></div>
            </div>

            <div class="text-end">
                <button type="submit" class="btn btn-primary">إرسال</button>
            </div>
        </form>
    </div>

    <!-- Right info box (unchanged from design page) -->
    <div class="contact-info-box">
        <h4>أو تواصل معنا من خلال</h4>

        <div class="contact-info-item">
            <div class="contact-info-label">Email Address</div>
            <div class="contact-info-value">info@foraskhadra.com</div>
        </div>

        <div class="contact-info-item">
            <div class="contact-info-label">WhatsApp</div>
            <div class="contact-info-value">+97012345678</div>
        </div>

        <img src="~/images/contact_illustration.svg"
             alt="Contact Illustration"
             class="contact-illustration" />
    </div>
</div>



@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/css/intlTelInput.css" />
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/intlTelInput.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js"></script>

    <script>
        const phoneInputField = document.querySelector("#phoneInput");
        const iti = window.intlTelInput(phoneInputField, {
            initialCountry: "auto",
            geoIpLookup: function(callback) {
                fetch("https://ipapi.co/json")
                    .then(res => res.json())
                    .then(data => callback(data.country_code))
                    .catch(() => callback("PS"));
            },
            separateDialCode: true,
            nationalMode: false,
            utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js"
        });

        const form = document.getElementById('contactForm');
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            // تحقق من صحة الفورم (HTML validation)
            if (!form.checkValidity()) {
                form.reportValidity(); // يسلط الضوء على الحقول الفارغة أو غير الصحيحة
                return;
            }

            // تحقق من الرقم قبل الإرسال
            if (!iti.isValidNumber()) {
                Swal.fire({
                    icon: 'error',
                    title: 'رقم غير صالح',
                    text: 'يرجى إدخال رقم هاتف صحيح'
                });
                return;
            }

            // ضع الرقم الدولي الكامل في الحقل المخفي
            document.getElementById("Phone").value = iti.getNumber();

            const formData = new FormData(form);
            formData.append("g-recaptcha-response", grecaptcha.getResponse());

            fetch('@Url.Action("Index", "Contact")', {
                method: 'POST',
                body: formData
            })
            .then(async response => {
                const data = await response.text();

                if (!response.ok) {
                    // 400 / 500
                    throw new Error(data || 'Something went wrong');
                }

                return data; // 200 فقط
            })
            .then(data => {
                Swal.fire({
                    icon: 'success',
                    title: 'Your message has been sent successfully!',
                    text: 'Thank you for contacting us, we will get back to you as soon as possible.',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#4CAF50',
                    background: '#ffffff',
                    color: '#1F4824'
                }).then(() => {
                    window.location.href = '@Url.Action("Index", "Home")';
                });

                form.reset();
                grecaptcha.reset();
            })
            .catch(err => {
                console.log(err.message);
                Swal.fire({
                    icon: 'error',
                    title: 'Something went wrong',
                    text:  'Please try again later'
                });
            });

        });
    </script>
}
