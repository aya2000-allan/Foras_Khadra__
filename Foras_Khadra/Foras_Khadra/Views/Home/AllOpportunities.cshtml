@model Foras_Khadra.Models.AllOpportunitiesViewModel
@using Foras_Khadra.Helpers
@using Microsoft.AspNetCore.Mvc.Rendering
@using System.Globalization;
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@{
    ViewData["Title"] = Localizer["PageTitle"];
    var lang = System.Globalization.CultureInfo.CurrentUICulture.TwoLetterISOLanguageName;
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="~/css/all-opportunities.css" />


<div class="page-wrapper container">
    <header class="custom-header">
        <div class="header-right">
            <div class="header-logo">
                <img src="/images/about_us_leaf.svg" alt="Logo" />
            </div>
            <h1 class="header-title">@Localizer["all_opportunities"]</h1>
        </div>
        <div class="header-left">
            @* Temporarly unimplemented *@
           @*  <div class="search-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </div> *@
            <div class="filter-btn" id="filterToggleBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>
            </div>
        </div>

        <div class="filter-window shadow" id="filterWindow">
            <div class="filter-window-header">
                <span class="sort-by-label">
                    @Localizer["sort_by"]
                    <i class="bi bi-caret-up-fill" style="font-size: 0.7rem; color: #B6C7B9;"></i>
                </span>
                <a href="@Url.Action("AllOpportunities", "Home")" class="reset-link">@Localizer["reset"]</a>
            </div>

            <form method="get">
                <div class="filter-option-item active" id="typeOptionTrigger">
                    <span>
                        @(lang switch
                        {
                            "en" => "Opportunity Type",
                            "fr" => "Type d'opportunité",
                            _ => "نوع الفرصة"
                        })
                    </span>
                    <i class="bi bi-caret-left-fill"></i>
                </div>
                
                <div class="filter-option-item" id="countryOptionTrigger">
                    <span> @Localizer["country"]</span>
                    <i class="bi bi-caret-left-fill"></i>
                </div>

                <div class="sub-filter-menu shadow" id="countrySubMenu">
                    <div class="p-2">
                        <label class="form-label mb-2" style="font-size: 0.9rem; color: #666;">@Localizer["enter_country_name"]</label>
                        <input type="text" name="country" class="form-control border-1 shadow-sm"
                               placeholder=" @Localizer["PS"]" value="@Model.SelectedCountry" id="countryInput"
                               style="font-size: 0.9rem; direction: rtl;">
                    </div>
                    <div class="sub-menu-footer mt-3">
                        <button type="button" class="btn-cancel-sub" id="cancelCountrySub">@Localizer["cancel"]</button>
                        <button type="submit" class="btn-search-sub"> @Localizer["search"]</button>
                    </div>
                </div>

                <div class="sub-filter-menu shadow" id="typeSubMenu">
                    @foreach (var item in Model.TypeSelectList)
                    {
                        <label class="checkbox-item">
                            <input type="checkbox" name="type" value="@item.Value" @(item.Selected ? "checked" : "")>
                            @item.Text
                        </label>
                    }


                    <div class="sub-menu-footer">
                        <button type="button" class="btn-cancel-sub" id="cancelSub">@Localizer["cancel"]</button>
                        <button type="submit" class="btn-search-sub">@Localizer["search"]</button>
                    </div>
                </div>
            </form>
        </div>
    </header>

    <div class="row g-4" >
        @if (!Model.Opportunities.Any())
        {
            <div class="col-12 text-center py-5">
                <p class="text-muted">
                    @(lang switch
                    {
                        "en" => "No opportunities match your search currently!",
                        "fr" => "Aucune opportunité ne correspond à votre recherche pour le moment !",
                        _ => "لا توجد فرص حالياً تطابق بحثك!"
                    })
            </p>
        </div>
        }
        else{
            @foreach (var opp in Model.Opportunities)
            {
                <div class="col-lg-4 col-md-6">
                    <div class="opp-card shadow-sm">
                        @if (!string.IsNullOrEmpty(opp.ImagePath))
                        {
                            string title = lang switch
                            {
                                "en" => opp.TitleEn,
                                "fr" => opp.TitleFr,
                                _ => opp.TitleAr
                            };
                            <img src="@opp.ImagePath" class="opp-image" alt="@title">
                        }
                        <div class="opp-category-row">
                            <span class="type-tag">@opp.Type.GetDisplayName(lang)</span>
                            @if (!string.IsNullOrWhiteSpace(opp.AvailableCountriesNames))
                            {
                                var allCountries = opp.AvailableCountriesNames
                                    .Split(',', StringSplitOptions.RemoveEmptyEntries)
                                    .Select(c => c.Trim())
                                    .ToList();

                                var text = string.Join(", ", allCountries.Take(2));

                                if (allCountries.Count > 2)
                                {
                                    text += "...";
                                }

                                <span class="category-tag">@text</span>
                            }
                            
                        </div>
                        @{
                            string title1 = lang switch
                            {
                                "en" => opp.TitleEn,
                                "fr" => opp.TitleFr,
                                _ => opp.TitleAr
                            };
                        }
                        <h3 class="opp-title">@title1</h3>

                        @{
                            string description = lang switch
                            {
                                "en" => opp.DescriptionEn,
                                "fr" => opp.DescriptionFr,
                                _ => opp.DescriptionAr
                            };
                        }
                        @{
                            var plainDescription = System.Text.RegularExpressions.Regex.Replace(description, "<.*?>", "");

                            // اقتطاع أول 10 كلمات
                            var words = plainDescription.Split(' ', StringSplitOptions.RemoveEmptyEntries);
                            var shortDescription = words.Length > 15 ? string.Join(' ', words.Take(10)) + "..." : plainDescription;
                        }
                        <p class="opp-description">@shortDescription</p>
                        <div>
                        @{
                            bool isExpired = opp.DeadlineType == DeadlineType.SpecificDate && opp.EndDate.HasValue && opp.EndDate.Value.Date < DateTime.Now.Date;

                            string statusText = opp.DeadlineType == DeadlineType.SpecificDate
                            ? (isExpired
                                ? (lang == "en" ? "Application Closed" : lang == "fr" ? "Candidature Terminée" : "انتهت فترة التقديم")
                            : (lang == "en" ? "Available" : lang == "fr" ? "Disponible" : "متاح التقديم"))
                            : (lang == "en" ? "Available" : lang == "fr" ? "Disponible" : "متاح التقديم");

                            string statusClass = isExpired ? "status-expired" : "status-available";
                        }
<div class="status-wrapper">
    <span class="opp-status @statusClass">@statusText</span>
</div>
                        </div>

                        
                          
                            <div class="opp-info-row">
                                <a href="@Url.Action("Details", "Opportunity", new { id = opp.Id })" class="btn-details">@Localizer["view_details"]</a>
                            </div>
                       

                    </div>

                  
                </div>
            }
        }
    </div>
    <div class="pagination-container mt-5 mb-5">
        <div class="next-page-prompt">
            <a href="#" id="nextPrompt">@Localizer["next_page"]</a>
        </div>

        <div class="pagination-controls" id="paginationControls">
            @* Arrows and numbers will be managed by JS *@
        </div>
    </div>
</div>

<script>
    const filterBtn = document.getElementById('filterToggleBtn');
    const filterWindow = document.getElementById('filterWindow');

    // Triggers
    const typeTrigger = document.getElementById('typeOptionTrigger');
    const countryTrigger = document.getElementById('countryOptionTrigger');

    // Sub-menus
    const typeSubMenu = document.getElementById('typeSubMenu');
    const countrySubMenu = document.getElementById('countrySubMenu');

    // Cancel buttons
    const cancelSub = document.getElementById('cancelSub');
    const cancelCountrySub = document.getElementById('cancelCountrySub');

    // Helper to clear active states
    function clearActiveStates() {
        typeTrigger.classList.remove('active');
        countryTrigger.classList.remove('active');
    }

    // Toggle Main Menu
    filterBtn.addEventListener('click', (e) => {
        const isOpening = filterWindow.style.display !== 'block';
        filterWindow.style.display = isOpening ? 'block' : 'none';

        // When closing the main window, close all submenus too
        if (!isOpening) {
            typeSubMenu.style.display = 'none';
            countrySubMenu.style.display = 'none';
            clearActiveStates();
        }
        e.stopPropagation();
    });

    // Toggle Type Sub-Menu
    typeTrigger.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpening = typeSubMenu.style.display !== 'block';

        // Close Country menu
        countrySubMenu.style.display = 'none';
        clearActiveStates();

        if (isOpening) {
            typeSubMenu.style.display = 'block';
            typeTrigger.classList.add('active');
        } else {
            typeSubMenu.style.display = 'none';
        }
    });

    // Toggle Country Sub-Menu
    countryTrigger.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpening = countrySubMenu.style.display !== 'block';

        // Close Type menu
        typeSubMenu.style.display = 'none';
        clearActiveStates();

        if (isOpening) {
            countrySubMenu.style.display = 'block';
            countryTrigger.classList.add('active');
        } else {
            countrySubMenu.style.display = 'none';
        }
    });

    // Cancel buttons logic
    cancelSub.addEventListener('click', (e) => {
        e.stopPropagation();
        typeSubMenu.style.display = 'none';
        typeTrigger.classList.remove('active');
    });

    cancelCountrySub.addEventListener('click', (e) => {
        e.stopPropagation();
        countrySubMenu.style.display = 'none';
        countryTrigger.classList.remove('active');
    });

    // Close everything when clicking outside
    document.addEventListener('click', (e) => {
        // Check if the click was outside the main window AND sub-menus
        if (!filterWindow.contains(e.target) && e.target !== filterBtn) {
            filterWindow.style.display = 'none';
            typeSubMenu.style.display = 'none';
            countrySubMenu.style.display = 'none';
            clearActiveStates();
        }
    });


          document.addEventListener('DOMContentLoaded', function () {
        const cardsPerPage = 12;
        const cardContainers = document.querySelectorAll('.row.g-4 > .col-lg-4'); // Selects the card wrappers
        const totalCards = cardContainers.length;
        const totalPages = Math.ceil(totalCards / cardsPerPage);
        const controlsContainer = document.getElementById('paginationControls');
        const nextPrompt = document.getElementById('nextPrompt');

        let currentPage = 1;

        function showPage(page) {
            currentPage = page;
            const start = (page - 1) * cardsPerPage;
            const end = start + cardsPerPage;

            // Hide all cards, then show only the ones for the current page
            cardContainers.forEach((card, index) => {
                card.style.display = (index >= start && index < end) ? 'block' : 'none';
            });

            renderControls();

            // Hide "Next Page" text if on the last page
            nextPrompt.parentElement.style.visibility = (currentPage === totalPages) ? 'hidden' : 'visible';

            // Scroll to top of grid smoothly
            document.querySelector('.row.g-4').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function renderControls() {
            let html = '';
         
                    
            // Left Arrow (Previous) - UI shows Left arrow for "Previous" in RTL
            html += `<a href="#" class="pagination-arrow prev-arrow ${currentPage === 1 ? 'disabled-link' : ''}" data-page="${currentPage - 1}">
                        <i class="bi bi-chevron-right"></i>
                    </a>`;

            // Page Numbers (Rendered in reverse 10...1 to match your RTL design)
            for (let i =1 ; i <= totalPages; i++) {
                
                html += `<a href="#" class="page-link-num ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</a>`;
            }

            // Right Arrow (Next)
            html += `<a href="#" class="pagination-arrow next-arrow ${currentPage === totalPages ? 'disabled-link' : ''}" data-page="${currentPage + 1}">
                                            <i class="bi bi-chevron-left"></i>
                                        </a>`;
           

            controlsContainer.innerHTML = html;

            // Add Click Events
            controlsContainer.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetPage = parseInt(link.getAttribute('data-page'));
                    if (targetPage >= 1 && targetPage <= totalPages) {
                        showPage(targetPage);
                    }
                });
            });
        }

        // "Next Page" prompt link
        nextPrompt.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentPage < totalPages) showPage(currentPage + 1);
        });

        // Initialize first page
        if (totalCards > 0) {
            showPage(1);
        } else {
            // Handle empty state if no cards found
            document.querySelector('.pagination-container').style.display = 'none';
        }
    });
</script>
