@model Foras_Khadra.Models.OrgOpportunityPageVM
@using Foras_Khadra.Helpers
@using Foras_Khadra.Models
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

@{
    ViewBag.Title = "فرص منظمتك";
    var lang = System.Globalization.CultureInfo.CurrentUICulture.TwoLetterISOLanguageName;

}

<div class="row mt-4">
    <!-- المحتوى الرئيسي -->
    <div class="col-md-9">
        <div class="tab-content" id="v-pills-tabContent">

            <!-- تاب عرض الفرص -->
            <div class="tab-pane fade show active" id="v-pills-list" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="mb-0">فرص منظمتك</h2>
                </div>

                @if (!Model.Opportunities.Any())
                {
                    <p>لا توجد فرص حالياً!!</p>
                }
                else
                {
                    <table class="table table-bordered table-striped align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>الصورة</th>
                                <th>العنوان</th>
                                <th>الوصف</th>
                                <th>الدولة</th>
                                <th>النوع</th>
                                <th>تاريخ النشر</th>
                                <th>إنشاء ريلز</th>
                                <th>حالة الطلب</th>
                                <th>إجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var opp in Model.Opportunities)
                            {
                                var nowUtc = DateTime.UtcNow;
                                var createdUtc = opp.PublishDate.ToUniversalTime();
                                var diffMinutes = (nowUtc - createdUtc).TotalMinutes;

                                var canEdit = diffMinutes <= 24 * 60;   // 24 ساعة
                                var canDelete = diffMinutes <= 48 * 60; // 48 ساعة

                                var isCompletedOrInProgress = opp.IsReelsCompleted || opp.IsReelsInProgress;
                                var isRejected = opp.IsReelsRejected;
                                var isPending = opp.HasRequestedReels && !opp.IsReelsCompleted && !opp.IsReelsInProgress && !opp.IsReelsRejected;

                                bool editCan = false;
                                bool deleteCan = false;
                                bool reelsCheckboxDisabled = false;

                                // المنطق الجديد
                                if (!opp.HasRequestedReels) // لم يتم طلب الرييلز
                                {
                                    editCan = canEdit;
                                    deleteCan = canDelete;
                                    reelsCheckboxDisabled = false;
                                }
                                else if (isRejected)
                                {
                                    // لو الفرصة مرفوضة: checkbox يظهر فقط إذا يمكن تعديل الفرصة
                                    editCan = canEdit; // true إذا تم تعديل الفرصة خلال 24 ساعة
                                    deleteCan = false;
                                    reelsCheckboxDisabled = !editCan; // لو ما ينعدل يبقى مخفي
                                }
                                else if (isPending)
                                {
                                    editCan = canEdit;
                                    deleteCan = canDelete;
                                    reelsCheckboxDisabled = false;
                                }
                                else if (isCompletedOrInProgress)
                                {
                                    editCan = false;
                                    deleteCan = false;
                                    reelsCheckboxDisabled = true;
                                }

                                // checkbox يظهر فقط إذا الفرصة لم ترفض
                                bool showCheckbox = !opp.IsReelsRejected;

                                <tr id="row-@opp.Id">
                                    <td style="width:80px;">
                                        @if (!string.IsNullOrEmpty(opp.ImagePath))
                                        {
                                            <img src="@opp.ImagePath"
                                                 alt="صورة الفرصة"
                                                 style="width:70px; height:70px; object-fit:cover; border-radius:5px;" />
                                        }
                                        else
                                        {
                                            <span>لا توجد صورة</span>
                                        }
                                    </td>
                                    @{
                                        string title = lang switch
                                        {
                                            "en" => opp.TitleEn,
                                            "fr" => opp.TitleFr,
                                            _ => opp.TitleAr
                                        };
                                    }
                                    <td>@title</td>
                                    @{
                                        string description = lang switch
                                        {
                                            "en" => opp.DescriptionEn,
                                            "fr" => opp.DescriptionFr,
                                            _ => opp.DescriptionAr
                                        };
                                    }
                                    <td>@description</td>
                                    <td>
                                        @if (opp.AvailableCountries != null && opp.AvailableCountries.Any())
                                        {
                                            var countryNames = opp.AvailableCountries.Select(c =>
                                            lang switch
                                            {
                                                "en" => c.NameEn,
                                                "fr" => c.NameFr,
                                                _ => c.NameAr
                                            });

                                            @string.Join(", ", countryNames)
                                        }
                                        else
                                        {
                                            <span>لا توجد دول محددة</span>
                                        }
                                    </td>

                                    <td>@opp.Type.GetDisplayName(lang)</td>
                                    <td>@opp.PublishDate.ToString("yyyy-MM-dd HH:mm")</td>
                                    <td class="checkbox-cell">
                                        @if (showCheckbox)
                                        {
                                            var isChecked = opp.HasRequestedReels && !opp.IsReelsRejected;
                                            <input type="checkbox"
                                                   @(isChecked ? "checked" : "")
                                                   @(reelsCheckboxDisabled ? "disabled" : "")
                                                   onchange="confirmReels(@opp.Id, this, '@opp.PublishDate.ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")')" />
                                        }
                                    </td>

                                    <td class="reels-status">
                                        @if (opp.HasRequestedReels)
                                        {
                                            if (opp.IsReelsRejected)
                                            {
                                                <span class="badge bg-danger">مرفوض</span>
                                                <br />
                                                <small class="text-muted">السبب: @opp.RejectionReason</small>
                                            }
                                            else if (opp.IsReelsCompleted)
                                            {
                                                <span class="badge bg-success">تم الانتهاء</span>
                                            }
                                            else if (opp.IsReelsInProgress)
                                            {
                                                <span class="badge bg-info">جاري العمل عليها</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-warning">قيد الانتظار</span>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted">لم يتم الطلب</span>
                                        }
                                    </td>
                                    <td>
                                        <a class="btn btn-primary btn-sm"
                                           href="@Url.Action("Details", "Opportunity", new { id = opp.Id })">
                                            عرض
                                        </a>

                                        <button class="btn btn-warning btn-sm"
                                                onclick="handleEdit(@opp.Id, '@editCan.ToString().ToLower()')"
                                                @(editCan ? "" : "disabled")>
                                            تعديل
                                        </button>

                                        <button class="btn btn-danger btn-sm"
                                                onclick="handleDelete(@opp.Id, '@deleteCan.ToString().ToLower()')"
                                                @(deleteCan ? "" : "disabled")>
                                            حذف
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>

            <!-- تاب إنشاء فرصة -->
            <div class="tab-pane fade" id="v-pills-create" role="tabpanel">
                <h2>إنشاء فرصة جديدة</h2>
                <form asp-controller="Opportunity" asp-action="Create" method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label>اسم المنظمة</label>
                        <input type="text" name="PublishedBy" class="form-control" value="@Model.OrganizationName" readonly />
                    </div>

                    <div class="mb-3">
                        <label>العنوان</label>
                        <input type="text" name="Title" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label>الوصف</label>
                        <textarea name="Description" class="form-control" rows="3" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label>التفاصيل</label>
                        <textarea name="Details" class="form-control" rows="3" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label>الدولة/البلدان المتاحة</label>
                        <textarea name="AvailableCountries" class="form-control" rows="2" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label>معايير الأهلية</label>
                        <textarea name="EligibilityCriteria" class="form-control" rows="2" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label>الفوائد</label>
                        <textarea name="Benefits" class="form-control" rows="2" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label>الصورة (اختياري)</label>
                        <input type="file" name="Image" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label>رابط التقديم</label>
                        <input type="url" name="ApplyLink" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label>النوع</label>
                        <select name="Type" class="form-control" required>
                            <option value="">-- اختر النوع --</option>
                            @foreach (OpportunityType type in Enum.GetValues(typeof(OpportunityType)))
                            {
                                <option value="@type">@type.ToString()</option>
                            }
                        </select>
                    </div>

                    <button type="submit" class="btn btn-success">إنشاء الفرصة</button>
                </form>
            </div>
        </div>
    </div>

    <!-- التاب الجانبي -->
    <div class="col-md-3">
        <div class="nav flex-column nav-pills ms-3" id="v-pills-tab" role="tablist" aria-orientation="vertical">
            <button class="nav-link active" id="v-pills-list-tab" data-bs-toggle="pill" data-bs-target="#v-pills-list" type="button" role="tab"> <a asp-action="OrgOpportunities" class="btn btn-primary">عرض الفرص</a></button>
            <button class="nav-link" id="v-pills-create-tab" data-bs-toggle="pill" data-bs-target="#v-pills-create" type="button" role="tab"> <a asp-action="Create" class="btn btn-primary">إنشاء فرصة جديدة</a></button>
        </div>
    </div>
</div>

<input type="hidden" id="RequestVerificationToken" value="@Antiforgery.GetAndStoreTokens(HttpContextAccessor.HttpContext).RequestToken" />

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function handleEdit(id, canEdit) {
        if (canEdit !== 'true') {
            Swal.fire({
                icon: 'warning',
                title: 'غير مسموح بالتعديل',
                text: 'لقد مر أكثر من 24 ساعة منذ إنشاء هذه الفرصة.'
            });
            return;
        }
        window.location.href = '/Opportunity/Edit/' + id;
    }

    function handleDelete(id, canDelete) {
        if (canDelete !== 'true') {
            Swal.fire({
                icon: 'warning',
                title: 'غير مسموح بالحذف',
                text: 'لقد مر أكثر من 48 ساعة منذ إنشاء هذه الفرصة.'
            });
            return;
        }

        Swal.fire({
            title: 'هل أنت متأكد من الحذف؟',
            text: "لن تتمكن من التراجع عن هذا الإجراء!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'نعم، احذفها!',
            cancelButtonText: 'إلغاء'
        }).then((result) => {
            if (result.isConfirmed) {
                const token = document.getElementById('RequestVerificationToken').value;
                fetch('/Opportunity/Delete/' + id, {
                    method: 'POST',
                    headers: { 'RequestVerificationToken': token }
                })
                .then(() => {
                    Swal.fire('تم الحذف!', 'تم حذف الفرصة بنجاح.', 'success')
                        .then(() => location.reload());
                });
            }
        });
    }

    async function confirmReels(opportunityId, checkbox, publishDate) {
        const checked = checkbox.checked;
        const created = new Date(publishDate); // الآن تستخدم UTC Z

        const now = new Date();
        const diffMs = now.getTime() - created.getTime();
        const hoursSinceCreation = diffMs / (1000 * 60 * 60);

        if (hoursSinceCreation > 24) {
            Swal.fire({
                icon: 'warning',
                title: 'غير مسموح بتغيير الطلب',
                text: 'لقد مر أكثر من 24 ساعة على إنشاء الفرصة، لا يمكنك تعديل حالة الرييلز الآن.'
            });
            checkbox.checked = !checked;
            return;
        }

        if (checkbox.disabled) return;

        const result = await Swal.fire({
            title: 'هل أنت متأكد؟',
            text: checked
                ? "هل تريد إرسال طلب الرييلز لهذه الفرصة؟"
                : "هل تريد إلغاء طلب الرييلز لهذه الفرصة؟",
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'نعم',
            cancelButtonText: 'لا'
        });

        if (result.isConfirmed) {
            const nowFinal = new Date();
            const hoursSinceCreationFinal = (nowFinal - created) / (1000 * 60 * 60);
            if (hoursSinceCreationFinal > 24) {
                Swal.fire({
                    icon: 'warning',
                    title: 'غير مسموح بتغيير الطلب',
                    text: 'لقد مر أكثر من 24 ساعة على إنشاء الفرصة، لا يمكن تعديل حالة الرييلز الآن.'
                });
                checkbox.checked = !checked;
                return;
            }
            toggleReels(opportunityId, checked, checkbox);
        } else {
            checkbox.checked = !checked;
        }
    }

    async function toggleReels(opportunityId, requestReels, checkbox) {
        try {
            const token = document.getElementById('RequestVerificationToken').value;
            const response = await fetch('/Opportunity/ToggleReelsRequest/' + opportunityId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                },
                body: JSON.stringify({ RequestReels: requestReels })
            });

            if (!response.ok) throw new Error('حدث خطأ أثناء إرسال الطلب.');

            const row = checkbox.closest('tr');
            const statusCell = row.querySelector('.reels-status');

            if (requestReels) {
                statusCell.innerHTML = '<span class="badge bg-warning">قيد الانتظار</span>';
            } else {
                checkbox.checked = false;
                statusCell.innerHTML = '<span class="text-muted">لم يتم الطلب</span>';
            }

            Swal.fire({
                icon: 'success',
                title: requestReels ? 'تم إرسال الطلب!' : 'تم إلغاء الطلب!',
                timer: 1500,
                showConfirmButton: false
            });

        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'خطأ',
                text: error.message
            });
            checkbox.checked = !requestReels;
        }
    }

    function showCompletedAlert() {
        Swal.fire({
            icon: 'info',
            title: 'تم اكتمال طلبك',
            text: 'بإمكانك مشاهدة طلبك على صفحات التواصل الاجتماعي الخاصة بنا',
            confirmButtonText: 'حسناً'
        });
    }

        function updateCheckboxAfterEdit(oppId, isRejected) {
        const checkboxCell = document.querySelector(`#row-${oppId} .checkbox-cell`);
        if(isRejected){
            checkboxCell.innerHTML = ''; // يختفي
        } else {
            checkboxCell.innerHTML = `<input type="checkbox" onchange="confirmReels(${oppId}, this)" />`;
        }
    }

</script>