@model Foras_Khadra.Models.OrgOpportunityPageVM
@using Foras_Khadra.Helpers
@using Foras_Khadra.Models
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

@{
    ViewBag.Title = "فرص منظمتك";
    var lang = System.Globalization.CultureInfo.CurrentUICulture.TwoLetterISOLanguageName;
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body { background:#f4f8f4; }
h2 { font-weight:800; color:#2f6b3c; }

.org-table { border-collapse: separate; border-spacing: 0 14px; }

.org-table thead th {
    border:none;
    background:transparent;
    color:#112D14;
    font-weight:700;
    font-size:14px;
}

.org-table tbody tr {
    background:#fff;
    box-shadow:0 4px 14px rgba(0,0,0,0.06);
    border-radius:16px;
}

.org-table tbody td {
    border:none;
    padding:18px 12px;
    vertical-align:middle;
}

.org-table img { border-radius:12px; }

.badge {
    padding:6px 14px;
    font-size:12px;
    border-radius:20px;
}

.badge.bg-warning { background:#f9a825 !important; color:#fff; }
.badge.bg-success { background:#2e7d32 !important; }
.badge.bg-danger  { background:#d32f2f !important; }
.badge.bg-info    { background:#0288d1 !important; }

.org-actions .btn {
    border-radius:50%;
    width:38px;
    height:38px;
    padding:0;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    margin:0 4px;
}

.org-actions .btn-primary { background:#2e7d32; border:none; }
.org-actions .btn-warning { background:#f9a825; border:none; color:#fff; }
.org-actions .btn-danger  { background:#d32f2f; border:none; }
.org-actions .btn-success { background:#2e7d32; border:none; }
.org-actions .btn-info    { background:#0288d1; border:none; color:#fff; }

.description-cell {
    max-width:300px;
    white-space:normal;
    word-break:break-word;
    line-height:1.6;
}

.table-separator {
    border-top: 1px solid #E5E5E5;
    margin-bottom: 20px;
}

.btn-add-opportunity {
    background: #F99D27; 
    border: none;
    color: #fff;
}
.btn-add-opportunity:hover {
    background: #F57C00;
    color: #fff;
}

@@media (max-width: 768px) {
    .org-table thead { display: none; }
    .org-table tbody tr { display: block; margin-bottom: 15px; }
    .org-table tbody td { display: flex; justify-content: space-between; padding: 10px; }
    .description-cell { max-width: 100%; }
}

/* ===== SweetAlert Styles ===== */
.swal2-popup.custom-swal {
  border-radius: 18px !important;
  padding: 22px 24px 18px !important;
  box-shadow: 0 10px 30px rgba(0,0,0,.12) !important;
  font-family: inherit;
  direction: rtl;
  width: 560px !important;
  max-width: calc(100% - 24px) !important;
}

.swal2-title.custom-swal-title {
  color: #1b1b1b !important;
  font-weight: 800 !important;
  font-size: 20px !important;
  margin-top: 6px !important;
}

.swal2-html-container.custom-swal-text {
  color: #2e7d32 !important;
  font-weight: 700 !important;
  font-size: 14px !important;
  margin-top: 4px !important;
}

.swal2-icon { display:none !important; }

.swal2-confirm.custom-swal-confirm {
  background:#F99D27 !important;
  color:#fff !important;
  border: 2px solid #F99D27 !important;
  border-radius: 12px !important;
  padding: 10px 34px !important;
  font-weight: 800 !important;
  min-width: 140px;
}

.swal2-cancel.custom-swal-cancel {
  background: transparent !important;
  color:#F99D27 !important;
  border: 2px solid #F99D27 !important;
  border-radius: 12px !important;
  padding: 10px 34px !important;
  font-weight: 800 !important;
  min-width: 140px;
}
</style>

<div class="container mt-4">

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>قائمة فرص منظمتك</h2>
    <a asp-action="Create" class="btn btn-add-opportunity">+ إضافة فرصة جديدة</a>
</div>
<div class="table-separator"></div>

@if (!Model.Opportunities.Any())
{
    <div class="alert alert-info">لا توجد فرص حالياً</div>
}
else
{
<table class="table align-middle org-table">
<thead>
<tr>
<th>الصورة</th>
<th>العنوان</th>
<th>الوصف</th>
<th>الدولة</th>
<th>النوع</th>
<th>التاريخ</th>
<th>الحالة</th>
<th></th>
</tr>
</thead>

<tbody>
@foreach (var opp in Model.Opportunities)
{
    var nowUtc = DateTime.UtcNow;
    var createdUtc = opp.PublishDate.ToUniversalTime();
    var diffMinutes = (nowUtc - createdUtc).TotalMinutes;

    var canEdit = diffMinutes <= 24 * 60;
    var canDelete = diffMinutes <= 48 * 60;

    var isCompletedOrInProgress = opp.IsReelsCompleted || opp.IsReelsInProgress;
    var isRejected = opp.IsReelsRejected;
    var isPending = opp.HasRequestedReels && !opp.IsReelsCompleted && !opp.IsReelsInProgress && !opp.IsReelsRejected;

    bool editCan = false;
    bool deleteCan = false;
    bool reelsDisabled = false;

    if (!opp.HasRequestedReels)
    {
        editCan = canEdit;
        deleteCan = canDelete;
    }
    else if (isRejected)
    {
        editCan = canEdit;
        deleteCan = false;
        reelsDisabled = !editCan;
    }
    else if (isPending)
    {
        editCan = canEdit;
        deleteCan = canDelete;
    }
    else if (isCompletedOrInProgress)
    {
        editCan = false;
        deleteCan = false;
        reelsDisabled = true;
    }

    string title = lang switch
    {
        "en" => opp.TitleEn,
        "fr" => opp.TitleFr,
        _ => opp.TitleAr
    };

    string description = lang switch
    {
        "en" => opp.DescriptionEn,
        "fr" => opp.DescriptionFr,
        _ => opp.DescriptionAr
    };

<tr id="row-@opp.Id" data-opp-title="@title">
<td style="width:80px;">
@if (!string.IsNullOrEmpty(opp.ImagePath))
{
    <img src="@opp.ImagePath" style="width:70px;height:70px;object-fit:cover;" />
}
</td>

<td>@title</td>
<td class="description-cell">@Html.Raw(description)</td>

<td>
@if (opp.AvailableCountries != null && opp.AvailableCountries.Any())
{
    var countryNames = opp.AvailableCountries.Select(c => lang switch
    {
        "en" => c.NameEn,
        "fr" => c.NameFr,
        _ => c.NameAr
    });
    @string.Join(", ", countryNames)
}
</td>

<td>@opp.Type.GetDisplayName(lang)</td>
<td>@opp.PublishDate.ToString("yyyy-MM-dd")</td>

<td class="reels-status">
@if (opp.HasRequestedReels)
{
    if (opp.IsReelsRejected)
    {
        <span class="badge bg-danger">مرفوض</span>
        <br />
        <small>@opp.RejectionReason</small>
    }
    else if (opp.IsReelsCompleted)
    {
        <span class="badge bg-success">تم الانتهاء</span>
    }
    else if (opp.IsReelsInProgress)
    {
        <span class="badge bg-info">جاري العمل</span>
    }
    else
    {
        <span class="badge bg-warning">قيد الانتظار</span>
    }
}
else
{
    <span class="text-muted">لم يتم الطلب</span>
}
</td>

<td class="org-actions">
<a class="btn btn-primary" href="@Url.Action("Details", "Opportunity", new { id = opp.Id })">
    <i class="bi bi-eye"></i>
</a>

<button class="btn btn-warning"
        onclick="handleEdit(@opp.Id, @editCan.ToString().ToLower())"
        @(editCan ? "" : "disabled")>
    <i class="bi bi-pencil"></i>
</button>

<button class="btn @(opp.HasRequestedReels && !opp.IsReelsRejected ? "btn-warning" : "btn-success")"
        title="طلب ريل"
        onclick="toggleReels(@opp.Id, @((opp.HasRequestedReels && !opp.IsReelsRejected).ToString().ToLower()))"
        @(reelsDisabled ? "disabled" : "")>
    <i class="bi bi-camera-reels"></i>
</button>

<button class="btn btn-danger"
        onclick="handleDelete(@opp.Id, @deleteCan.ToString().ToLower())"
        @(deleteCan ? "" : "disabled")>
    <i class="bi bi-trash"></i>
</button>
</td>
</tr>
}
</tbody>
</table>
}

</div>

<input type="hidden" id="RequestVerificationToken"
value="@Antiforgery.GetAndStoreTokens(HttpContextAccessor.HttpContext).RequestToken" />

<script>
const SwalConfirmUI = Swal.mixin({
  customClass: {
    popup: 'custom-swal',
    title: 'custom-swal-title',
    htmlContainer: 'custom-swal-text',
    confirmButton: 'custom-swal-confirm',
    cancelButton: 'custom-swal-cancel'
  },
  buttonsStyling: false,
  showCloseButton: true,
  reverseButtons: true,
  imageUrl: '@Url.Content("~/images/Group.svg")',
  imageWidth: 90,
  imageHeight: 90,
  imageAlt: ''
});

function getOppTitle(id) {
  const row = document.getElementById('row-' + id);
  return row?.dataset?.oppTitle || '';
}

/* Swal نجاح */
function showSuccess(message) {
  return Swal.fire({
    icon: 'success',
    title: message,
    confirmButtonText: 'موافق',
    customClass: {
      popup: 'custom-swal',
      title: 'custom-swal-title',
      confirmButton: 'custom-swal-confirm'
    },
    buttonsStyling: false
  });
}

function handleEdit(id, canEdit) {
    if (!canEdit) {
        Swal.fire({ icon:'warning', title:'غير مسموح', text:'مر أكثر من 24 ساعة.' });
        return;
    }
    window.location.href = '/Opportunity/Edit/' + id;
}

function handleDelete(id, canDelete) {
    if (!canDelete) {
        Swal.fire({ icon:'warning', title:'غير مسموح', text:'مر أكثر من 48 ساعة.' });
        return;
    }

    const oppTitle = getOppTitle(id);

    SwalConfirmUI.fire({
        title:'هل تريد تأكيد حذف هذه الفرصة؟',
        html: oppTitle ? oppTitle : '',
        showCancelButton:true,
        confirmButtonText:'تأكيد',
        cancelButtonText:'تراجع'
    }).then((result)=>{
        if(result.isConfirmed){
            const token = document.getElementById('RequestVerificationToken').value;
            fetch('/Opportunity/Delete/' + id, {
                method:'POST',
                headers:{ 'RequestVerificationToken': token }
            })
            .then(res => {
                if (!res.ok) throw new Error('error');
                return showSuccess('تم حذف الفرصة بنجاح!');
            })
            .then(() => location.reload())
            .catch(() => {
                Swal.fire({ icon:'error', title:'خطأ', text:'حدث خطأ أثناء تنفيذ العملية' });
            });
        }
    });
}

async function toggleReels(id, hasRequest) {

    const oppTitle = getOppTitle(id);

    const result = await SwalConfirmUI.fire({
        title: hasRequest
            ? 'هل تريد التراجع عن طلب ريل لهذه الفرصة؟'
            : 'هل تريد تأكيد طلب ريل لهذه الفرصة؟',
        html: oppTitle ? oppTitle : '',
        showCancelButton:true,
        confirmButtonText:'تأكيد',
        cancelButtonText:'تراجع'
    });

    if (!result.isConfirmed) return;

    const token = document.getElementById('RequestVerificationToken').value;

    fetch('/Opportunity/ToggleReelsRequest/' + id, {
        method:'POST',
        headers:{
            'Content-Type':'application/json',
            'RequestVerificationToken': token
        },
        body: JSON.stringify({ RequestReels: !hasRequest })
    })
    .then(res => {
        if (!res.ok) throw new Error('error');
        return showSuccess(
            !hasRequest
                ? 'تم إرسال طلب إنشاء ريل للفرصة بنجاح!'
                : 'تم التراجع عن طلب الريل بنجاح!'
        );
    })
    .then(() => location.reload())
    .catch(() => {
        Swal.fire({ icon:'error', title:'خطأ', text:'حدث خطأ أثناء تنفيذ العملية' });
    });
}
</script>
