@model Foras_Khadra.Models.OpportunityEditVM

@{
    ViewData["Title"] = "تعديل الفرصة";
}

<link rel="stylesheet" href="~/css/opportunity-create.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />

<div class="header">
    <h2 class="page-title"> تعديل الفرصة </h2>
    @if (!User.IsInRole("Organization"))
    {
        <a asp-controller="Admin" asp-action="Index" class="btn-back-dashboard">
            العودة للوحة التحكم
        </a>
    }
</div>

<div class="page-wrapper">

    <!-- Form panel -->
    <div class="form-panel">
        <form id="editForm"
              method="post"
              enctype="multipart/form-data"
              asp-action="Edit">

            <div asp-validation-summary="All" class="validation-summary"></div>

            <!-- Image upload -->
            <div class="upload-box">
                <h3 class="discription">رفع صورة الفرصة </h3>
                @if (!string.IsNullOrEmpty(Model.ImagePath))
                {
                    <div class="current-image-preview" style="display:flex;align-items:center;gap:12px;margin-bottom:12px; background-color:#EEF1F7; justify-content:space-between; border-radius:26px;padding:12px;">
                        <img src="@Model.ImagePath" alt="صورة الفرصة" style="width:90px;height:auto;border-radius:16px;box-shadow:0 1px 4px rgba(0,0,0,0.08);" />
                        <button type="button" id="deleteImageBtn" title="حذف الصورة" style="height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;text-decoration:none;font-size:1.5rem;border:1px solid #ff383c;color:#ff383c;background:none;">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </div>
                }
                <label class="upload-area">
                    <input asp-for="Image" id="ImageInput" type="file" hidden />
                    <div class="upload-icon"><img src="~/images/upload-icon.svg" alt=""></div>
                    <p>Drag & drop files or <a href="#">Browse</a></p>
                    <small>JPEG, PNG</small>
                </label>
                <input type="hidden" name="RemoveImage" id="RemoveImage" value="false" />
                <span asp-validation-for="Image" class="text-danger"></span>
            </div>

            <!-- PublishedBy -->
            <div class="field">
                @if (!string.IsNullOrEmpty(Model.PublishedBy))
                {
                    <input asp-for="PublishedBy" placeholder="نشر بواسطة : Admin" readonly />
                }
                else
                {
                    <input asp-for="PublishedBy" placeholder="نشر بواسطة" />
                }
                <span asp-validation-for="PublishedBy" class="text-danger"></span>
            </div>

            <!-- Type -->
            <div class="field dropdown">
                <select asp-for="Type" asp-items="Html.GetEnumSelectList<OpportunityType>()" required>
                    <option value="">اختر نوع الفرصة</option>
                </select>
                <img src="~/images/lets-icons_arrow-drop-down.svg" class="custom-dropdown-arrow" />
                <span asp-validation-for="Type" class="text-danger"></span>
            </div>

            <!-- Tabs للغات -->
            <ul class="nav nav-tabs" id="languageTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="ar-tab" data-bs-toggle="tab" data-bs-target="#tabAr" type="button" role="tab">عربي</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="en-tab" data-bs-toggle="tab" data-bs-target="#tabEn" type="button" role="tab">English</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="fr-tab" data-bs-toggle="tab" data-bs-target="#tabFr" type="button" role="tab">Français</button>
                </li>
            </ul>

            <div class="tab-content mt-3">
                <!-- Arabic Tab -->
                <div class="tab-pane fade show active" id="tabAr" role="tabpanel">
                    <div class="field">
                        <input asp-for="TitleAr" placeholder="عنوان الفرصة" required />
                        <span asp-validation-for="TitleAr" class="text-danger"></span>
                    </div>
                    <div class="field">
                        <label>دول الفرصة</label>
                        <select asp-for="AvailableCountryIds" asp-items="Model.CountriesSelectList" multiple class="form-select" required></select>
                        <span asp-validation-for="AvailableCountryIds" class="text-danger"></span>
                    </div>
                    <div class="field">
                        <textarea asp-for="EligibilityCriteriaAr" rows="2" placeholder="حدد معايير أهلية الفرصة" required></textarea>
                        <span asp-validation-for="EligibilityCriteriaAr" class="text-danger"></span>
                    </div>
                    <div class="field">
                        <textarea asp-for="DescriptionAr" rows="3" placeholder="وصف الفرصة" required></textarea>
                        <span asp-validation-for="DescriptionAr" class="text-danger"></span>
                    </div>
                    <div class="field">
                        <textarea asp-for="BenefitsAr" rows="2" placeholder="الفوائد" required></textarea>
                        <span asp-validation-for="BenefitsAr" class="text-danger"></span>
                    </div>
                    <div class="field">
                        <h3 class="discription">تفاصيل الفرصة</h3>
                        <div id="editorAr" style="height: 200px;"></div>
                        <input type="hidden" asp-for="DetailsAr" id="detailsAr" />
                        <span asp-validation-for="DetailsAr" class="text-danger"></span>
                    </div>
                </div>

                <!-- English Tab -->
                <div class="tab-pane fade" id="tabEn" role="tabpanel">
                    <div class="field">
                        <input asp-for="TitleEn" placeholder="Opportunity Title" required />
                        <span asp-validation-for="TitleEn" class="text-danger"></span>
                    </div>
                    <div class="field">
                        <label>Available Countries</label>
                        <select asp-for="AvailableCountryIds" asp-items="Model.CountriesSelectList" multiple class="form-select" required></select>
                        <span asp-validation-for="AvailableCountryIds" class="text-danger"></span>
                    </div>
                    <div class="field">
                        <textarea asp-for="EligibilityCriteriaEn" rows="2" placeholder="Eligibility Criteria" required></textarea>
                        <span asp-validation-for="EligibilityCriteriaEn" class="text-danger"></span>
                    </div>
                    <div class="field">
                        <textarea asp-for="DescriptionEn" rows="3" placeholder="Opportunity Description" required></textarea>
                        <span asp-validation-for="DescriptionEn" class="text-danger"></span>
                    </div>
                    <div class="field">
                        <textarea asp-for="BenefitsEn" rows="2" placeholder="Benefits" required></textarea>
                        <span asp-validation-for="BenefitsEn" class="text-danger"></span>
                    </div>
                    <div class="field">
                        <h3 class="discription">Opportunity Details</h3>
                        <div id="editorEn" style="height: 200px;"></div>
                        <input type="hidden" asp-for="DetailsEn" id="detailsEn" />
                        <span asp-validation-for="DetailsEn" class="text-danger"></span>
                    </div>
                </div>

                <!-- French Tab -->
                <div class="tab-pane fade" id="tabFr" role="tabpanel">
                    <div class="field">
                        <input asp-for="TitleFr" placeholder="Titre de l'opportunité" required />
                        <span asp-validation-for="TitleFr" class="text-danger"></span>
                    </div>
                    <div class="field">
                        <label>Pays disponibles</label>
                        <select asp-for="AvailableCountryIds" asp-items="Model.CountriesSelectList" multiple class="form-select" required></select>
                        <span asp-validation-for="AvailableCountryIds" class="text-danger"></span>
                    </div>
                    <div class="field">
                        <textarea asp-for="EligibilityCriteriaFr" rows="2" placeholder="Critères d'éligibilité" required></textarea>
                        <span asp-validation-for="EligibilityCriteriaFr" class="text-danger"></span>
                    </div>
                    <div class="field">
                        <textarea asp-for="DescriptionFr" rows="3" placeholder="Description de l'opportunité" required></textarea>
                        <span asp-validation-for="DescriptionFr" class="text-danger"></span>
                    </div>
                    <div class="field">
                        <textarea asp-for="BenefitsFr" rows="2" placeholder="Avantages" required></textarea>
                        <span asp-validation-for="BenefitsFr" class="text-danger"></span>
                    </div>
                    <div class="field">
                        <h3 class="discription">Détails de l'opportunité</h3>
                        <div id="editorFr" style="height: 200px;"></div>
                        <input type="hidden" asp-for="DetailsFr" id="detailsFr" />
                        <span asp-validation-for="DetailsFr" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <!-- Apply Link -->
            <div class="field mt-3">
                <input asp-for="ApplyLink" placeholder="رابط التقديم" required />
                <span asp-validation-for="ApplyLink" class="text-danger"></span>
            </div>

            <!-- Actions -->
            <div class="actions mt-3">
                <button type="submit" class="btn-primary">حفظ التعديلات</button>
                @if (User.IsInRole("Organization"))
                {
                    <a asp-action="OrgOpportunities" class="btn-outline">إلغاء</a>
                }
                else
                {
                    <a asp-action="Index" class="btn-outline">إلغاء</a>
                }
            </div>

        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // Initialize Quill editors for all languages
        var quillAr = new Quill('#editorAr', { theme: 'snow', placeholder: 'اكتب التفاصيل هنا...' });
        var quillEn = new Quill('#editorEn', { theme: 'snow', placeholder: 'Write details here...' });
        var quillFr = new Quill('#editorFr', { theme: 'snow', placeholder: 'Écrivez les détails ici...' });

        // Populate editors
        quillAr.clipboard.dangerouslyPasteHTML(@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DetailsAr ?? "")));
        quillEn.clipboard.dangerouslyPasteHTML(@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DetailsEn ?? "")));
        quillFr.clipboard.dangerouslyPasteHTML(@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DetailsFr ?? "")));

        // Sync hidden inputs on submit
        document.getElementById('editForm').addEventListener('submit', function() {
            document.getElementById('detailsAr').value = quillAr.root.innerHTML;
            document.getElementById('detailsEn').value = quillEn.root.innerHTML;
            document.getElementById('detailsFr').value = quillFr.root.innerHTML;
        });

        // Delete image logic
        var deleteBtn = document.getElementById('deleteImageBtn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', function () {
                var preview = document.querySelector('.current-image-preview');
                if (preview) preview.style.display = 'none';
                document.getElementById('RemoveImage').value = 'true';
                var fileInput = document.getElementById('ImageInput');
                if (fileInput) fileInput.value = '';
            });
        }
    </script>
}
