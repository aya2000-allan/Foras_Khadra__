@model Foras_Khadra.Models.OpportunityEditVM

@{
    ViewData["Title"] = "تعديل الفرصة";
}

<link rel="stylesheet" href="~/css/opportunity-create.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
<link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet" />

<div class="header">
    <h2 class="page-title"> تعديل الفرصة </h2>
    @if (!User.IsInRole("Organization"))
    {
        <a asp-controller="Admin" asp-action="Index" class="btn-back-dashboard">
            العودة للوحة التحكم
        </a>
    }

    <style>
        .countries-checkboxes .form-check-input {
            width: 16px;
            height: 16px;
            transform: scale(0.9);
            margin-top: 0.2rem;
        }

        .countries-checkboxes .form-check-label {
            font-size: 14px;
            margin-right: 6px;
        }

        .countries-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 8px 12px;
        }


    </style>
</div>

<div class="page-wrapper">

    <div class="form-panel">
        <form id="editForm" method="post" enctype="multipart/form-data" asp-action="Edit">

            <div asp-validation-summary="All" class="validation-summary"></div>

            <!-- Image upload -->
            <div class="upload-box">
                <h3 class="discription">رفع صورة الفرصة </h3>
                @if (!string.IsNullOrEmpty(Model.ImagePath))
                {
                    <div class="current-image-preview" style="display:flex;align-items:center;gap:12px;margin-bottom:12px; background-color:#EEF1F7; justify-content:space-between; border-radius:26px;padding:12px;">
                        <img src="@Model.ImagePath" alt="صورة الفرصة" style="width:90px;height:auto;border-radius:16px;box-shadow:0 1px 4px rgba(0,0,0,0.08);" />
                        <button type="button" id="deleteImageBtn" title="حذف الصورة" style="height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;text-decoration:none;font-size:1.5rem;border:1px solid #ff383c;color:#ff383c;background:none;">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </div>
                }
                <label class="upload-area">
                    <input asp-for="Image" id="ImageInput" type="file" hidden />
                    <div class="upload-icon"><img src="~/images/upload-icon.svg" alt=""></div>
                    <p>Drag & drop files or <a href="#">Browse</a></p>
                    <small>JPEG, PNG</small>
                </label>
                <input type="hidden" name="RemoveImage" id="RemoveImage" value="false" />
                <span asp-validation-for="Image" class="text-danger"></span>
            </div>

            <!-- PublishedBy -->
            <div class="field">
                <input asp-for="PublishedBy" readonly value="@Model.PublishedBy" placeholder="نشر بواسطة" class="published-by-box" />
                <span asp-validation-for="PublishedBy" class="text-danger"></span>
            </div>

            <!-- Type -->
            <div class="field dropdown">
                <select asp-for="Type" asp-items="Html.GetEnumSelectList<OpportunityType>()" required>
                    <option value="">اختر نوع الفرصة</option>
                </select>
                <img src="~/images/lets-icons_arrow-drop-down.svg" class="custom-dropdown-arrow" />
                <span asp-validation-for="Type" class="text-danger"></span>
            </div>

            <div class="field">
                <label class="form-label">دول الفرصة</label>

                <div class="countries-checkboxes">
                    @foreach (var country in Model.CountriesSelectList)
                    {
                        <div class="form-check">
                            <input class="form-check-input"
                                   type="checkbox"
                                   name="AvailableCountryIds"
                                   value="@country.Value"
                                   @(country.Selected ? "checked" : "") />

                            <label class="form-check-label">
                                @country.Text
                            </label>
                        </div>
                    }
                </div>

                <span asp-validation-for="AvailableCountryIds" class="text-danger"></span>
            </div>
            <!-- Tabs -->
            <ul class="nav nav-tabs" id="languageTabs" role="tablist">
                <li class="nav-item"><a class="nav-link active" id="ar-tab" data-bs-toggle="tab" href="#tabAr" role="tab">عربي</a></li>
                <li class="nav-item"><a class="nav-link" id="en-tab" data-bs-toggle="tab" href="#tabEn" role="tab">English</a></li>
                <li class="nav-item"><a class="nav-link" id="fr-tab" data-bs-toggle="tab" href="#tabFr" role="tab">Français</a></li>
            </ul>

            <div class="tab-content mt-3">
                <!-- Arabic -->
                <div class="tab-pane fade show active" id="tabAr" role="tabpanel">
                    <div class="field">
                        <input asp-for="TitleAr" placeholder="عنوان الفرصة" required />
                        <span asp-validation-for="TitleAr" class="text-danger"></span>
                    </div>
                    

                    <div class="field"><textarea asp-for="EligibilityCriteriaAr" rows="2" placeholder="حدد معايير أهلية الفرصة" required></textarea></div>
                    <div class="field"><textarea asp-for="DescriptionAr" rows="3" placeholder="وصف الفرصة" required></textarea></div>
                    <div class="field"><textarea asp-for="BenefitsAr" rows="2" placeholder="الفوائد" required></textarea></div>
                    <div class="field">
                        <h3 class="discription">تفاصيل الفرصة</h3>
                        <div id="editorAr" style="height: 200px;"></div>
                        <input type="hidden" asp-for="DetailsAr" id="detailsAr" />
                    </div>
                </div>

                <!-- English -->
                <div class="tab-pane fade" id="tabEn" role="tabpanel">
                    <div class="field"><input asp-for="TitleEn" placeholder="Opportunity Title" required /></div>
                    <div class="field"><textarea asp-for="EligibilityCriteriaEn" rows="2" placeholder="Eligibility Criteria" required></textarea></div>
                    <div class="field"><textarea asp-for="DescriptionEn" rows="3" placeholder="Opportunity Description" required></textarea></div>
                    <div class="field"><textarea asp-for="BenefitsEn" rows="2" placeholder="Benefits" required></textarea></div>
                    <div class="field">
                        <h3 class="discription">Opportunity Details</h3>
                        <div id="editorEn" style="height: 200px;"></div>
                        <input type="hidden" asp-for="DetailsEn" id="detailsEn" />
                    </div>
                </div>

                <!-- French -->
                <div class="tab-pane fade" id="tabFr" role="tabpanel">
                    <div class="field"><input asp-for="TitleFr" placeholder="Titre de l'opportunité" required /></div>
                    <div class="field"><textarea asp-for="EligibilityCriteriaFr" rows="2" placeholder="Critères d'éligibilité" required></textarea></div>
                    <div class="field"><textarea asp-for="DescriptionFr" rows="3" placeholder="Description de l'opportunité" required></textarea></div>
                    <div class="field"><textarea asp-for="BenefitsFr" rows="2" placeholder="Avantages" required></textarea></div>
                    <div class="field">
                        <h3 class="discription">Détails de l'opportunité</h3>
                        <div id="editorFr" style="height: 200px;"></div>
                        <input type="hidden" asp-for="DetailsFr" id="detailsFr" />
                    </div>
                </div>
            </div>

            <!-- Apply Link -->
            <div class="field mt-3">
                <input asp-for="ApplyLink" placeholder="رابط التقديم" required />
            </div>

            <!-- Actions -->
            <div class="actions mt-3">
                <button type="submit" class="btn-primary">حفظ التعديلات</button>
                @if (User.IsInRole("Organization"))
                {
                    <a asp-action="OrgOpportunities" class="btn-outline">إلغاء</a>
                }
                else
                {
                    <a asp-action="Index" class="btn-outline">إلغاء</a>
                }
            </div>

        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // Initialize Quill editors
        var quillAr = new Quill('#editorAr', { theme: 'snow', placeholder: 'اكتب التفاصيل هنا...' });
        var quillEn = new Quill('#editorEn', { theme: 'snow', placeholder: 'Write details here...' });
        var quillFr = new Quill('#editorFr', { theme: 'snow', placeholder: 'Écrivez les détails ici...' });

        // Load previous content
        quillAr.clipboard.dangerouslyPasteHTML(@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DetailsAr ?? "")));
        quillEn.clipboard.dangerouslyPasteHTML(@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DetailsEn ?? "")));
        quillFr.clipboard.dangerouslyPasteHTML(@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DetailsFr ?? "")));

        // Submit sync
        document.getElementById('editForm').addEventListener('submit', function() {
            document.getElementById('detailsAr').value = quillAr.root.innerHTML;
            document.getElementById('detailsEn').value = quillEn.root.innerHTML;
            document.getElementById('detailsFr').value = quillFr.root.innerHTML;
        });

        // Delete image
        var deleteBtn = document.getElementById('deleteImageBtn');
        if(deleteBtn){
            deleteBtn.addEventListener('click', function(){
                var preview = document.querySelector('.current-image-preview');
                if(preview) preview.style.display = 'none';
                document.getElementById('RemoveImage').value = 'true';
                var fileInput = document.getElementById('ImageInput');
                if(fileInput) fileInput.value = '';
            });
        }
    </script>
}
