@model Dictionary<Foras_Khadra.Models.OpportunityType, List<Foras_Khadra.Models.Opportunity>>
@inject Foras_Khadra.Data.ApplicationDbContext _context

@{
    var organizations = _context.Organizations.Select(o => o.Name).ToList();
    var selectedOrg = Context.Request.Query["organization"].ToString();
    
    // Flatten model for easier pagination/list rendering while keeping the "Internship" label logic
    var allFilteredOpportunities = Model.Values.SelectMany(x => x)
        .Where(o => string.IsNullOrEmpty(selectedOrg) || o.PublishedBy == selectedOrg)
        .ToList();
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="~/css/admin-opportunities.css" />

<div class="page-wrapper container-fluid p-0">
    <header class="admin-header">
        <div class="header-container">
            <h1 class="header-title">قائمة الفرص</h1>
            
            <div class="header-actions">
                <div class="search-filter-wrapper">
                   @*  <div class="search-icon">
                        <i class="bi bi-search"></i>
                    </div> *@
                    <div class="filter-btn" id="filterToggleBtn">
                        <i class="bi bi-sliders"></i>
                    </div>
                    
                    <div class="filter-window shadow" id="filterWindow">
                        <div class="p-3">
                            <label class="form-label mb-2">فلتر حسب المنظمة</label>
                            <select class="form-select" onchange="filterByOrganization(this.value)">
                                <option value="">كل المنظمات</option>
                                @foreach (var org in organizations)
                                {
                                    <option value="@org" selected="@(org == selectedOrg ? "selected" : null)">@org</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>

                <a asp-action="Create" class="btn-add-opportunity">
                    <span>+</span> إضافة فرصة جديدة
                </a>
                @if (!User.IsInRole("Organization"))
                {
                    <a asp-controller="Admin" asp-action="Dashboard" class="btn-back-dashboard">
                                    العودة للوحة التحكم
                                </a>
                }
                
            </div>
        </div>
    </header>

    <div class="content-body container py-4">
        <div class="table-labels d-none d-md-flex">
            <div class="label-col title-label" style="text-align:end">عنوان الفرصة</div>
            <div class="label-col actions-label"></div>
            <div class="label-col" style="text-align:start">نوع الفرصة</div>
            <div class="label-col">اسم المنظمة</div>
            <div class="label-col actions-label"></div>

        </div>

        <div class="opportunity-list">
            @if (!allFilteredOpportunities.Any())
            {
                <div class="text-center py-5 text-black">
                    <p>لا توجد فرص حالياً تطابق هذا البحث.</p>
                </div>
            }
            else
            {
                @foreach (var opp in allFilteredOpportunities)
                {
                    <div class="opportunity-row-card">

                        <div class="title-col">
                            <div class="opp-img-container">
                                <img src="@(string.IsNullOrEmpty(opp.ImagePath) ? "/images/default.jpg" : opp.ImagePath)" alt="Opp Image" />
                            </div>
                            <span class="opp-title-text">@opp.Title</span>
                        </div>

                         <div class="info-col">
                            @opp.Type.ToString()
                        </div>

                         <div class="info-col">
                            @opp.PublishedBy
                        </div>
                         <div class="action-buttons">
                           <a href="@Url.Action("Details", "Opportunity", new { id = opp.Id })" class="action-icon view-btn">
                                <i class="bi bi-eye-fill"></i>
                            </a>
                            <a href="@Url.Action("Edit", "Opportunity", new { id = opp.Id })" class="action-icon edit-btn">
                                <i class="bi bi-pencil-fill"></i>
                            </a>
                            
                             <form method="post" >
                                <button type="button"
                                        class="action-icon delete-btn"
                                        onclick="openDeleteModal('@opp.Id', '@opp.Title')">
                                    <i class="bi bi-trash-fill"></i>
                                </button>                           
                             </form>
                        </div>

                    </div>
                }
            }
        </div>

        <div class="pagination-container mt-5">
            <div class="next-page-prompt">
                <a href="#" id="nextPrompt">انتقل إلى الصفحة التالية</a>
            </div>
            <div class="pagination-controls" id="paginationControls"></div>
        </div>
    </div>
</div>
<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="delete-overlay">
    <div class="delete-box">

        <button class="delete-close" onclick="closeDeleteModal()">×</button>

        <div class="delete-illustration">
            <img src="/images/delete-confirm.png" alt="Delete illustration">
        </div>

        <h2 class="delete-title">
            هل أنت متأكد من حذف الفرصة التالية ؟
        </h2>

        <p id="deleteOppName" class="delete-name">
            اسم الفرصة التي تم اختيارها
        </p>

        <div class="delete-actions">
            <button class="btn-back" onclick="closeDeleteModal()">تراجع</button>

            <form id="deleteForm" method="post">
                <button type="submit" class="btn-danger">حذف</button>
            </form>
        </div>
    </div>
</div>
<script>
    function filterByOrganization(org) {
        const url = new URL(window.location.href);
        if (org) url.searchParams.set('organization', org);
        else url.searchParams.delete('organization');
        window.location.href = url.toString();
    }

    // Toggle Filter Window
    const filterBtn = document.getElementById('filterToggleBtn');
    const filterWindow = document.getElementById('filterWindow');
    if(filterBtn) {
        filterBtn.onclick = (e) => {
            filterWindow.style.display = filterWindow.style.display === 'block' ? 'none' : 'block';
            e.stopPropagation();
        };
    }
    document.onclick = () => filterWindow.style.display = 'none';
    filterWindow.onclick = (e) => e.stopPropagation();

    // Pagination Logic (Preserved from your code)
    document.addEventListener('DOMContentLoaded', function () {
        const cardsPerPage = 10;
        const items = document.querySelectorAll('.opportunity-row-card');
        const totalPages = Math.ceil(items.length / cardsPerPage);
        const controls = document.getElementById('paginationControls');
        const nextPrompt = document.getElementById('nextPrompt');
        let currentPage = 1;

        function showPage(page) {
            currentPage = page;
            const start = (page - 1) * cardsPerPage;
            const end = start + cardsPerPage;
            items.forEach((item, index) => {
                item.style.display = (index >= start && index < end) ? 'flex' : 'none';
            });
            renderControls();
            nextPrompt.parentElement.style.visibility = (currentPage === totalPages) ? 'hidden' : 'visible';
        }

        function renderControls() {
            let html = `<a href="#" class="pagination-arrow prev-arrow ${currentPage === 1 ? 'disabled-link' : ''}" data-page="${currentPage - 1}"><i class="bi bi-chevron-right"></i></a>`;
            for (let i = 1; i <= totalPages; i++) {
                html += `<a href="#" class="page-link-num ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</a>`;
            }
            html += `<a href="#" class="pagination-arrow next-arrow ${currentPage === totalPages ? 'disabled-link' : ''}" data-page="${currentPage + 1}"><i class="bi bi-chevron-left"></i></a>`;
            controls.innerHTML = html;
            controls.querySelectorAll('a').forEach(link => {
                link.onclick = (e) => {
                    e.preventDefault();
                    showPage(parseInt(link.dataset.page));
                }
            });
        }
        if (items.length > 0) showPage(1);
    });
</script>

<script>
    const deleteModal = document.getElementById("deleteModal");
    const deleteForm = document.getElementById("deleteForm");
    const deleteOppName = document.getElementById("deleteOppName");

    function openDeleteModal(id, title) {
        deleteOppName.textContent = title;
        deleteForm.action = `/Opportunity/Delete/${id}`;
        deleteModal.style.display = "flex";
    }

    function closeDeleteModal() {
        deleteModal.style.display = "none";
    }
</script>