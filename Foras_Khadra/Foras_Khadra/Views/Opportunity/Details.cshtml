@using System.Globalization
@model Foras_Khadra.Models.Opportunity
@using Foras_Khadra.Helpers
@using System.Globalization;
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@{

    var lang = System.Globalization.CultureInfo.CurrentUICulture.TwoLetterISOLanguageName;
    string pageTitle = lang switch
    {
        "en" => Model.TitleEn,
        "fr" => Model.TitleFr,
        _ => Model.TitleAr
    };
    ViewData["Title"] = pageTitle;


    var isExpired = false;

    if (Model.DeadlineType == DeadlineType.SpecificDate && Model.EndDate.HasValue)
    {
        isExpired = Model.EndDate.Value.Date < DateTime.Now.Date;
    }
    var applyButtonClass = "apply-button " + (isExpired ? "expired-button" : "active-button");

}

<style>
    /* ===== دائرة التوثيق ===== */
    .verify-badge-circle {
        display: inline-flex; /* لتوسيط المحتوى داخل الدائرة */
        justify-content: center;
        align-items: center;
        width: 22px; /* حجم الدائرة */
        height: 22px;
        background-color: #F99D27;
        color: white; /* لون العلامة داخل الدائرة */
        border-radius: 50%; /* يجعلها دائرة */
        font-size: 14px; /* حجم علامة الصح */
        font-weight: bold;
        margin-left: 6px; /* مسافة بين النص والدائرة */
        vertical-align: middle; /* يرفع الدائرة لمستوى النص */
        box-shadow: 0 1px 3px rgba(0,0,0,0.2); /* ظل خفيف لإبراز الدائرة */
        transition: all 0.2s ease; /* تأثير عند التحويم لو حبيت تضيف hover */
    }

        /* تأثير عند التحويم على الدائرة */
        .verify-badge-circle:hover {
            background-color: #e08a1c;
            transform: scale(1.1); /* تكبير بسيط */
            cursor: default;
        }

    .section-title {
        text-align: inherit;
    }
    /* ===== اتجاه الصفحة ===== */

    .opp-container[dir="rtl"] {
        direction: rtl;
        text-align: right;
    }

    .opp-container[dir="ltr"] {
        direction: ltr;
        text-align: left;
    }

    /* ===== سهم الرجوع احترافي ونهائي ===== */

    .back-link {
        text-decoration: none;
        display: inline-flex;
        align-items: center;
    }

    .back-arrow {
        color: #F99D27;
        font-size: 22px;
        display: inline-block;
        transition: transform 0.2s ease;
    }

    html[dir="ltr"] .back-arrow {
        transform: rotate(180deg);
    }
    
   
    .opp-container[dir="rtl"] .verify-badge-circle {
        margin-right: 6px;
        margin-left: 0;
    }

    .opp-container[dir="ltr"] .verify-badge-circle {
        margin-left: 6px;
        margin-right: 0;
    }
    /* ===== سهم الرجوع حسب اللغة ===== */

    

    /* أيقونة السهم */
    .back-icon {
        transition: transform 0.2s ease;
    }

    .back-link {
        text-decoration: none;
        color: #F99D27;
        font-size: 22px;
        display: inline-flex;
        align-items: center;
    }
    .ltr-content {
        text-align: left;
        direction: ltr;
    }

    .rtl-label {
        text-align: right;
        direction: rtl;
    }

    .ltr-label {
        text-align: left;
        direction: ltr;
    }

    /* إنجليزي + فرنسي LTR → السهم يطلع لليمين */
    .opp-container[dir="ltr"] .back-icon {
        transform: scaleX(-1);
    }

    /* ===== القوائم بنقطة الورقة (Details + Eligibility + Benefits + Description) ===== */

/* نلغي النقاط الافتراضية */
.section-content ul,
.section-content ol,
.info-value ul,
.info-value ol {
  list-style: none;
  padding-inline-start: 0;
  margin: 0 0 1rem 0;
}

/* كل عنصر بالقائمة */
.section-content li,
.info-value li {
  position: relative;
  padding-inline-start: 36px;   /* مسافة للنص بعد الأيقونة */
  margin-bottom: 10px;
  line-height: 1.7;
}

/* أيقونة الورقة */
.section-content li::before,
.info-value li::before {
  content: "";
  position: absolute;
  inset-inline-start: 0;       /* يشتغل صح مع RTL/LTR */
  top: 0.35em;
  width: 22px;
  height: 22px;
  background-repeat: no-repeat;
  background-size: contain;
  background-image: url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 54 54'>\
<circle cx='27' cy='27' r='27' fill='%23F99D27'/>\
<path d='M21.9102 25.2275C22.0085 25.1232 22.1263 25.0392 22.2569 24.9804C22.3876 24.9216 22.5286 24.8891 22.6718 24.8848C22.815 24.8805 22.9577 24.9045 23.0916 24.9553C23.2256 25.0062 23.3482 25.0829 23.4525 25.1811C28.4727 29.9102 33.51 32.7875 39.4377 34.2541C40.2375 32.0723 40.3084 29.6709 39.6177 27.3282C38.7014 24.2198 36.5673 21.5116 33.448 19.4968C30.6634 17.6982 27.8802 17.2298 25.1877 16.777C21.7909 16.2057 18.5823 15.6657 15.5202 12.4236C15.1793 12.065 14.715 11.9211 14.2711 12.0377C13.7639 12.1741 13.4236 12.575 13.2607 13.2377C12.8789 14.7889 13.1243 19.1361 14.1982 23.7254C15.9225 31.0986 18.6743 34.8295 20.6796 36.6616C23.2705 39.0268 26.6536 40.3366 30.0157 40.3366C30.6494 40.3376 31.2823 40.2911 31.9091 40.1975C34.753 39.7666 37.1202 38.3382 38.4546 36.26C32.353 34.6727 27.1405 31.6543 21.9546 26.7718C21.8501 26.6734 21.766 26.5554 21.7072 26.4245C21.6484 26.2935 21.616 26.1523 21.6119 26.0088C21.6078 25.8654 21.632 25.7225 21.6832 25.5884C21.7344 25.4544 21.8116 25.3317 21.9102 25.2275Z' fill='white'/>\
</svg>");
}

/* ===== في LTR (إنجليزي / فرنسي): اقلب الورقة ===== */
.opp-container[dir="ltr"] .section-content li::before,
.opp-container[dir="ltr"] .info-value li::before {
  transform: scaleX(-1);
}
</style>


<link href="~/css/opportunity-deatails.css" rel="stylesheet" />
@{
    var isRtl = lang == "ar";
    var dir = isRtl ? "rtl" : "ltr";
}
<div class="opp-container" dir="@dir">
    <div class="opp-header">
        <div class="opp-title">
            <div class="btn-back-container">
                @if (User.IsInRole("Admin"))
                {
                    <a asp-controller="Opportunity" asp-action="Index" class="back-link"><span class="back-arrow">↪</span></a>
                }
                else if (User.IsInRole("Organization"))
                {
                    <a asp-controller="Opportunity" asp-action="OrgOpportunities" class="back-link"><span class="back-arrow">↪</span></a>
                }
                else
                {
                    <a asp-controller="Home" asp-action="AllOpportunities" class="back-link"><span class="back-arrow">↪</span></a>
                }
            </div>
            @{
                string title = lang switch
                {
                    "en" => Model.TitleEn,
                    "fr" => Model.TitleFr,
                    _ => Model.TitleAr
                };
            }
            <span>@title</span>



        </div>
        @if (User.IsInRole("Admin") || User.IsInRole("User") || User.IsInRole("Organization"))
        {
            <a href="@(isExpired ? "javascript:void(0);" : Model.ApplyLink)"
               target="@(isExpired ? "_self" : "_blank")"
               class="@applyButtonClass"
               @(isExpired ? "title='الفرصة منتهية'" : "")>
                @Localizer["ApplyNow"]
            </a>
        }
        else if (!User.Identity.IsAuthenticated)
        {
            <a href="javascript:void(0);" class="@applyButtonClass" id="guestApply">@Localizer["ApplyNow"]</a>
        }
       
    </div>

    <div class="main-card">
        <div class="card-info-content">
            <div class="info-grid">
                <span class="info-label">@Localizer["PublishDate"]</span>
                <span class="info-value">@Model.PublishDate.ToShortDateString()</span>

                <span class="info-label">@Localizer["Deadline"]</span>
                <span class="info-value">
                    @{
                        string deadlineText = "";
                        string deadlineClass = "";

                        if (Model.DeadlineType == DeadlineType.SpecificDate && Model.EndDate.HasValue)
                        {
                            deadlineText = Model.EndDate.Value.ToShortDateString();
                            deadlineClass = isExpired ? "deadline-expired" : "deadline-active";
                        }
                        else if (Model.DeadlineType == DeadlineType.UntilFull)
                        {
                            deadlineText = Localizer["UntilFull"].Value;
                            deadlineClass = "deadline-active";
                        }
                        else
                        {
                            deadlineText = Localizer["NotSpecified"].Value;
                            deadlineClass = "deadline-active";
                        }
                    }

                    <span class="deadline-label @deadlineClass">
                        @deadlineText
                    </span>
                </span>

                <span class="info-label">@Localizer["OpportunityType"]</span>
                <span class="info-value">@Model.Type.GetDisplayName(lang)</span>
                
                <span class="info-label">@Localizer["Publisher"]</span>
                <span class="info-value">
                    @{
                        string publisherText;

                        if (Model.IsPublishedByAdmin)
                        {
                            // الفرصة موثقة إداريا
                            publisherText = lang switch
                            {
                                "ar" => "فرص خضراء",
                                _ => "Foras Khadra"
                            };
                        }
                        else
                        {
                            // الفرصة منشورة من المنظمة نفسها
                            publisherText = Model.PublishedBy;
                        }
                    }
                    @publisherText

                    @if (Model.IsPublishedByAdmin)
                    {
                        <iconify-icon icon="mdi:check-decagram"
                                      style="color:#25652C; font-size:20px; vertical-align:middle;">
                        </iconify-icon>
                    }
                </span>

                <span class="info-label">@Localizer["AvailableCountries"]</span>
                <span class="info-value">
                    @string.Join(", ", Model.AvailableCountries.Select(c =>
                    lang switch
                    {
                        "en" => c.NameEn,
                        "fr" => c.NameFr,
                        _ => c.NameAr
                    }
                                        ))
                </span>
                <span class="info-label">@Localizer["Description"]</span>
                @{
                    string description = lang switch
                    {
                        "en" => Model.DescriptionEn,
                        "fr" => Model.DescriptionFr,
                        _ => Model.DescriptionAr
                    };
                }
                <span class="info-value">@Html.Raw(description)</span>


            </div>
            
        </div>
        <div class="card-image-wrapper">
            @if (!string.IsNullOrEmpty(Model.ImagePath))
            {
                <img src="@Model.ImagePath" alt="Opportunity Image" />
            }
            else
            {
                <div style="background:#eee; height:100%;"></div>
            }
        </div>
    </div>

    <div class="details-card">
        <div class="section-title @(lang == "ar" ? "rtl-label" : "ltr-label")">@Localizer["Details"]</div>
        @{
            string details = lang switch
            {
                "en" => Model.DetailsEn,
                "fr" => Model.DetailsFr,
                _ => Model.DetailsAr
            };
            string detailsClass = (lang == "en" || lang == "fr") ? "section-content ltr-content" : "section-content";
        }
        <div class="@detailsClass">@Html.Raw(details)</div>

        <div class="section-title @(lang == "ar" ? "rtl-label" : "ltr-label")">@Localizer["EligibilityCriteria"]</div>
        @{
            string eligibilitycriteria = lang switch
            {
                "en" => Model.EligibilityCriteriaEn,
                "fr" => Model.EligibilityCriteriaFr,
                _ => Model.EligibilityCriteriaAr
            };
            string eligibilityClass = (lang == "en" || lang == "fr") ? "section-content ltr-content" : "section-content";
        }
        <div class="@eligibilityClass">@Html.Raw(eligibilitycriteria)</div>

        <div class="section-title @(lang == "ar" ? "rtl-label" : "ltr-label")">@Localizer["Benefits"]</div>
        @{
            string benefits = lang switch
            {
                "en" => Model.BenefitsEn,
                "fr" => Model.BenefitsFr,
                _ => Model.BenefitsAr
            };
            string benefitsClass = (lang == "en" || lang == "fr") ? "section-content ltr-content" : "section-content";
        }
        <div class="@benefitsClass">@Html.Raw(benefits)</div>
    </div>

   
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // جلب لغة الموقع الحالية من Razor
        const currentLang = '@CultureInfo.CurrentUICulture.TwoLetterISOLanguageName';

        // إعداد نصوص التنبيهات حسب اللغة
        const swalTexts = {
            title: 'تسجيل الدخول مطلوب !',
            html: 'أنشئ حساب لتتمكن من التقديم ، وإذا كان لديك حساب بالفعل<br>سجل الدخول الآن',
            confirm: 'حسناً',
            dir: 'rtl' // الافتراضي عربي
        };

        if(currentLang === 'en') {
            swalTexts.title = 'Login Required!';
            swalTexts.html = 'Create an account to apply, or login if you already have one.';
            swalTexts.confirm = 'OK';
            swalTexts.dir = 'ltr';
        }
        else if(currentLang === 'fr') {
            swalTexts.title = 'Connexion requise !';
            swalTexts.html = 'Créez un compte pour postuler, ou connectez-vous si vous en avez déjà un.';
            swalTexts.confirm = 'OK';
            swalTexts.dir = 'ltr';
        }

        document.getElementById("guestApply")?.addEventListener("click", function () {
            Swal.fire({
                imageUrl: '/images/login-required.svg',
                imageWidth: 165,
                imageHeight: 129,
                imageAlt: 'Login required illustration',
                title: swalTexts.title,
                html: swalTexts.html,
                showCancelButton: false,
                confirmButtonText: swalTexts.confirm,
                customClass: {
                    popup: 'custom-swal-popup',
                    title: 'custom-swal-title',
                    htmlContainer: 'custom-swal-text',
                    confirmButton: 'custom-swal-confirm',
                    closeButton: 'custom-swal-close'
                },
                showCloseButton: true,
                buttonsStyling: false,
                didOpen: () => {
                    const popup = Swal.getPopup();
                    popup.style.border = '1px solid #C77E1F';
                    popup.style.borderRadius = '16px';
                    popup.style.paddingBottom = '25px';
                    popup.style.paddingTop = '20px';
                    popup.style.width='740px';

                    // ضبط اتجاه النص داخل الـ Swal
                    popup.style.direction = swalTexts.dir;
                    popup.querySelector('.swal2-title')?.setAttribute('dir', swalTexts.dir);
                    popup.querySelector('.swal2-html-container')?.setAttribute('dir', swalTexts.dir);
                }
            });
        });
    </script>
    <style>
       
        .custom-swal-title {
            color: #333;
            font-size: 24px;
            font-weight: 700;
        }
        
        .custom-swal-text {
            color: #666;
            font-size: 20px;
        }
       


        .custom-swal-confirm {
            background-color: #F99D27;
            color: white;
            border: none;
            padding: 14px 45px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 8px;
            width: auto;
            height: auto;
            border-radius: 16px;
        }
        
        .custom-swal-confirm:hover {
            background-color: #e88d1a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(249, 157, 39, 0.3);
        }
        
        .custom-swal-close {
            color: #999;
            font-size: 28px;
            position: relative;
            left: auto !important;
            right: -93% !important;
        }
        
        .custom-swal-close:hover {
            color: #F99D27;
        }

        .deadline-label {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .apply-button {
            padding: 12px 30px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 16px;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-block;
        }

       
       

        /* الزر الفاهي عند انتهاء الفرصة */
        .expired-button {
            background-color: #F99D27; /* فاهي */
            color: white;
            cursor: not-allowed; /* مؤشر عدم التفاعل */
            opacity: 0.9;
        }
        .deadline-active {
            background-color: #25652C; /* أخضر */
        }

        .deadline-expired {
            background-color: #dc3545; /* أحمر */
        }
    </style>
}