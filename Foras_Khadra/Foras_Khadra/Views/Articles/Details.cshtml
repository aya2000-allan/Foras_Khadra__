@model Article
@using System
@using System.Linq

@{
    ViewData["Title"] = Model.Title;

    // مقالات واصلة من الكنترولر
    var latest = ViewBag.LatestArticles as IEnumerable<Article> ?? Enumerable.Empty<Article>();

    // المقالات القريبة زمنيًا
    var relatedArticles = latest
        .Where(a => a.Id != Model.Id)
        .OrderBy(a => Math.Abs((a.PublishDate - Model.PublishDate).TotalDays))
        .Take(3)
        .ToList();

    var req = Context.Request;
    var currentUrl = $"{req.Scheme}://{req.Host}{req.Path}{req.QueryString}";
    var encodedUrl = Uri.EscapeDataString(currentUrl);
    var encodedTitle = Uri.EscapeDataString(Model.Title ?? "");

    var shareX = $"https://twitter.com/intent/tweet?url={encodedUrl}&text={encodedTitle}";
    var shareFacebook = $"https://www.facebook.com/sharer/sharer.php?u={encodedUrl}";
    var shareLinkedIn = $"https://www.linkedin.com/sharing/share-offsite/?url={encodedUrl}";
    var shareWhatsApp = $"https://wa.me/?text={encodedTitle}%20{encodedUrl}";
}

@section Styles {
    <link rel="stylesheet" asp-append-version="true" href="~/css/articles-details.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
}

<div class="news-article-page" dir="rtl">
    <div class="container-fluid px-4">

        <main class="col-12">
            <article class="news-card">

                <!-- ===== Top Bar ===== -->
                <div class="news-top-bar">
                    <a href="javascript:history.back()" class="news-back-btn" aria-label="رجوع">
                        ←
                    </a>

                    <div class="news-top-meta">
                        <span class="news-top-title">@Model.Title</span>
                        <span class="news-top-author">
                            @Model.Author

                            @if (Model.Author == "فرص خضراء")
                            {
                                <i class="fa-solid fa-circle-check verified-icon"
                                   title="جهة موثوقة"></i>
                            }
                        </span>
                    </div>
                </div>

                <!-- ===== Hero Image ===== -->
                @if (!string.IsNullOrEmpty(Model.ImagePath))
                {
                    <div class="news-hero">
                        <img src="@Model.ImagePath" alt="@Model.Title" />
                    </div>
                }

                <!-- ===== Meta ===== -->
                <div class="news-meta-bar">
                    <div class="news-date">
                        @Model.PublishDate.ToString("dd MMM yyyy")
                    </div>
                </div>

                <!-- ===== Body ===== -->
                <div class="news-body-grid">

                    <!-- Content -->
                    <div class="news-main-content">
                        <div class="news-content">
                            @Html.Raw(Model.Content)
                        </div>
                    </div>

                    <!-- Sidebar -->
                    @if (!User.IsInRole("Admin") && relatedArticles.Any())
                    {
                        <aside class="news-inline-sidebar">

                            <section class="sideblock">
                                <div class="sideblock-head">
                                    <h3 class="sideblock-title">اقرأ أيضًا</h3>
                                </div>

                                <div class="sideblock-list">
                                    @foreach (var a in relatedArticles)
                                    {
                                        <a class="mini-card" asp-action="Details" asp-route-id="@a.Id">
                                            <img src="@a.ImagePath"
                                                 alt="@a.Title"
                                                 style="width:100%;height:140px;object-fit:cover;border-radius:10px;" />

                                            <div class="mini-card-body">
                                                <div class="mini-card-title">@a.Title</div>
                                                <div class="mini-card-sub">
                                                    @a.PublishDate.ToString("dd MMM yyyy")
                                                </div>
                                            </div>
                                        </a>
                                    }
                                </div>

                                <a asp-action="Index" class="sideblock-more">
                                    عرض المزيد من المقالات
                                </a>
                            </section>

                        </aside>
                    }

                </div>
            </article>
        </main>

    </div>
</div>
